{% extends 'base.html' %}
<link rel="stylesheet" href="../static/socialDist/styles.css">
{% block content %}

<head>
    <!-- FontAwesome Icons link -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css"
        integrity="sha512-KfkfwYDsLkIlwQp6LFnl8zNdLGxu9YAA1QvwINks4PhcElQSvqcyVLLD9aMhXd13uQjoXtEKNosOWaZqXgel0g=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<main>
    <div class="container-md mt-2">
        <div class="grid" id="posts">
            <div class="d-flex justify-content-center">
                <div class="spinner-border">
                    <span class="visually-hidden">Loading Posts...</span>
                </div>
            </div>
        </div>
</main>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    const listOfConnections = JSON.parse('{{connections|escapejs}}');

    function deletePost(id) {
        // DELETE a post
        url = new URL(id)
        fetch_url = "/api" + url.pathname + "/"
        fetch(fetch_url, { headers: new Headers({ "X-CSRFToken": "{{ csrf_token }}", "Authorization": "Token 516e5c3d636f46228edb8f09b9613d5b4b166816" }), method: 'DELETE' })
            .then((response) => response.status())
            .then(window.location.reload())
    }
    //https://www.w3docs.com/snippets/html/how-to-create-an-html-button-that-acts-like-a-link.html
    function editPost(id) {
        url = new URL(id)
        window.location.href = url.pathname + "/edit/"
    }
    var current_author = JSON.parse('{{current_author|escapejs}}');
    let posts, externalPosts;
    // GET all public posts and display them
    fetch("/api/posts/", { headers: new Headers({ "Authorization": "Token 516e5c3d636f46228edb8f09b9613d5b4b166816" }) })
        .then((response) => response.json())
        .then((data) => {
            if (data.items.length === 0) {
                document.getElementById('posts').innerHTML = `<div class="d-flex justify-content-center py-4"><h3>No posts to show.</h3></div>`
                return
            }
            posts = data.items;
            document.getElementById('posts').innerHTML = posts.map((post, index) => {
                let content;
                if (post.contentType.startsWith("image")) {
                    content = `<img class="img-fluid mx-auto d-block" style="max-width: 50%" src="data:${post.contentType}, ${post.content}"/><br>`;
                }
                else {
                    if (post.contentType === "text/markdown") {
                        post.title = marked.parse(post.title);
                        post.description = marked.parse(post.description);
                        content = `<p class="card-text">${marked.parse(post.content)}</p>`;
                    } else {
                        content = `<p class="card-text">${post.content}</p>`;
                    }
                }
                post_url = new URL(post.id);
                author_url = new URL(post.author.url);
                post_relative_path = post_url.pathname + "/";
                author_relative_path = author_url.pathname + "/";
                author_arr = author_url.pathname.split("/");
                post_arr = post_url.pathname.split("/");
                post_id = post_arr[post_arr.length - 1];
                author_id = author_arr[author_arr.length - 1];
                display_posts = `
                            <div class="card my-3" id="post-${post_id}">
                                <div class="card-body">
                                    <h5 class="card-title"><a href="${post_relative_path}">${post.title}</a></h5>
                                    <h6 class="card-subtitle mb-2 text-muted"><a href="${author_relative_path}">${post.author.displayName}</a></h6>
                                    <h6 class="card-subtitle mb-2 text-muted">${post.description}</h6>
                                    <span class="badge bg-secondary">${post.categories}</span>
                                    ${content}
                                    <button type="button" class="btn btn-secondary btn-sm" id="like-btn-${index}" onclick="likePost(${index}, 'internal')">
                                        <i class="fa-regular fa-heart"></i>
                                    </button>`
                if (post.author.id == current_author.id) {
                    display_posts += `
                                    <button type="button" class="btn btn-secondary btn-sm" onclick="editPost('${post.id}')">
                                    Edit
                                    </button>
                                    <button type="button" class="btn btn-danger btn-sm" onclick="deletePost('${post.id}')">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                    `
                }
                isLiked(index, 'internal'); // check if post is liked by user
                return (display_posts + '</div></div>')
            }).join('');
        })
        .catch((error) => {
            console.error("Fetch error:", error);
            document.getElementById('posts').innerHTML = `<div class="d-flex justify-content-center py-4"><h3>Error fetching posts</h3></div>`
        });

    async function likePost(i, type) {
        // i is the index of the post in the posts/externalPosts array
        // type is either internal or external
        const source = type === "internal" ? posts : externalPosts;
        const post = source[i];
        const authorID = post.author.id.split("/").pop();
        const hostname = type === "external" ? "https://" + new URL(post.author.id).hostname : "";
        let url = `${hostname}/api/authors/${authorID}/inbox/`;
        if (hostname === "https://social-distribution-w23-t17.herokuapp.com"){
            url = `${hostname}/authors/${post.author.id}/inbox/`;
        }
        let authorization = "Token 516e5c3d636f46228edb8f09b9613d5b4b166816";
        if (type === "external") {
            const remoteConnection = listOfConnections.find(connection => connection.hostName === hostname);
            authorization = remoteConnection.apiCreds;
        }
        const data = {
            "@context": "Post Like",
            "summary": "{{ user.username }} Likes your post",
            "type": "Like",
            "author": current_author,
            "object": post.id
        }
        // POST a like object to the author's inbox
        const response = await fetch(url, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}",
                "Authorization": authorization
            },
            body: JSON.stringify(data),
        });
        if (response.status == 200) {
            document.getElementById(`like-btn-${i}`).innerHTML = `<i class="fa-solid fa-heart"></i>`;
            document.getElementById(`like-btn-${i}`).disabled = true;
        } else {
            console.log(response.status, response.statusText)
        }
    }

    async function isLiked(i, type) {
        // checks if current user liked the post
        // i is the index of the post in the posts/externalPosts array
        // type is either internal or external
        const source = type === "internal" ? posts : externalPosts;
        const post = source[i];
        const authorID = post.author.id.split("/").pop();
        const hostname = type === "external" ? "https://" + new URL(post.author.id).hostname : "";
        let url = `${hostname}/api/authors/${authorID}/posts/${post.id.split('/').pop()}/likes/`;
        if (hostname === "https://social-distribution-w23-t17.herokuapp.com"){
            url = `${hostname}/authors/${authorID}/posts/${post.id.split('/').pop()}/likes/`;
        }
        let authorization = "Token 516e5c3d636f46228edb8f09b9613d5b4b166816";
        if (type === "external") {
            const remoteConnection = listOfConnections.find(connection => connection.hostName === hostname);
            authorization = remoteConnection.apiCreds;
        }
        // GET list of likes for the post
        const response = await fetch(url, {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}",
                "Authorization": authorization,
            },
        }).then(response => response.json())
            .then(data => {
                for (like of data.items) {
                    if (like.author.id == current_author.id) {
                        document.getElementById(`like-btn-${i}`).innerHTML = `<i class="fa-solid fa-heart"></i>`;
                        document.getElementById(`like-btn-${i}`).disabled = true;
                    }
                }
            });
    }

    fetchExternalPosts();
    //Source: https://stackoverflow.com/questions/494143/creating-a-new-dom-element-from-an-html-string-using-built-in-dom-methods-or-pro/35385518#35385518
    function htmlToElement(html) {
        var template = document.createElement('template');
        template.innerHTML = html;
        return template.content;
    }

    async function fetchExternalPosts() {
        var listOfConnections = JSON.parse('{{connections|escapejs}}');
        // fetch foreign posts and render
        //Source: https://stackoverflow.com/questions/43305020/how-to-use-the-context-variables-passed-from-django-in-javascript
        for (connection of listOfConnections) {
            try {
                let returnedData;
                let queryString = "";
                if (connection.hostName == "https://social-distribution-w23-t17.herokuapp.com") {
                queryString = "?page=1&size=1000"
                }
                if (connection.apiCreds === "") {
                    returnedData = await fetch(connection.apiAddress + "/authors/" + queryString, 
                    {headers: new Headers({"Accept": "application/json"})});
                }
                else {
                    returnedData = await fetch(connection.apiAddress + "/authors/" + queryString,
                        { headers: new Headers({ "Authorization": connection.apiCreds, 
                        "Accept": "application/json"}) });
                }
                let returnedDatatext = await returnedData.text();
                let returnedDataList = JSON.parse(returnedDatatext);
                if (returnedDataList.items.length == 0) {
                    continue
                }
                for (data of returnedDataList.items) {
                    // https://dmitripavlutin.com/parse-url-javascript/
                    try {
                        let data_url = new URL(data.id);
                        let data_path = data_url.pathname;
                        let index = data_path.search("/api")
                        if (index != -1) {
                            data_path = data_path.substring(index + 4)
                        }
                        let posts_response;
                        if (connection.hostName == "https://social-distribution-w23-t17.herokuapp.com") {
                            posts_response = await fetch(connection.apiAddress + "/authors/" + data.id + "/posts/",
                            { headers: new Headers({ "Authorization": connection.apiCreds,
                            "Accept": "application/json", }) });
                        }
                        else {
                            posts_response = await fetch(connection.apiAddress + data_path + "/posts/",
                            { headers: new Headers({ "Authorization": connection.apiCreds,
                            "Accept": "application/json", }) });
                        }
                  
                        let posts_list_json = await posts_response.text();
                        let post_list_obj = JSON.parse(posts_list_json);
                        let posts;
                        if (post_list_obj.items == undefined) {
                            posts = post_list_obj;
                        }
                        else {
                            posts = post_list_obj.items;
                        }
                        if (posts.length == 0) {
                            continue;
                        }
                        externalPosts = posts
                        let i = 0;
                        for (post of posts) {
                            try {
                                let content;
                                // ensure we dont render unlisted posts of our connected nodes
                                if (post.unlisted) {
                                    continue
                                }
                                if (post.contentType.startsWith("image")) {
                                    content = `<img class="img-fluid mx-auto d-block" style="max-width: 50%" src="data:${post.contentType}, ${post.content}"/><br>`;
                                } else if (post.contentType === "text/markdown") {
                                    post.title = marked.parse(post.title);
                                    post.description = marked.parse(post.description);
                                    content = `<p class="card-text">${marked.parse(post.content)}</p>`;
                                } else {
                                    content = `<p class="card-text">${post.content}</p>`;
                                }
                                var htmlElement = htmlToElement(`
                                            <div class="card my-3">
                                                <div class="card-body">
                                                    <h5 class="card-title"><a href="${post.id}">${post.title}</a></h5>
                                                    <h6 class="card-subtitle mb-2 text-muted"><a href="${post.author.url}">${post.author.displayName}</a></h6>
                                                    <h6 class="card-subtitle mb-2 text-muted">${post.description}</h6>
                                                    <span class="badge bg-secondary">${post.categories}</span>
                                                    ${content}
                                                    <button type="button" class="btn btn-secondary btn-sm" id="like-btn-${i}" onclick="likePost(${i}, 'external')">
                                                        <i class="fa-regular fa-heart"></i> 
                                                    </button>
                                                </div>
                                            </div>
                                        `);
                                document.getElementById("posts").appendChild(htmlElement);
                                isLiked(i, 'external');
                            }
                            catch {
                                continue;
                            }
                        }
                    }
                    catch {
                        continue;
                    }
                }
            }
            catch {
                continue;
            }
        }
    }
</script>

{% endblock content %}