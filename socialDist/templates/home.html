{% extends 'base.html' %}
<link rel="stylesheet" href="../static/socialDist/styles.css">
{% block content %}

<head>
    <!-- FontAwesome Icons link -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css"
        integrity="sha512-KfkfwYDsLkIlwQp6LFnl8zNdLGxu9YAA1QvwINks4PhcElQSvqcyVLLD9aMhXd13uQjoXtEKNosOWaZqXgel0g=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<main>
    <div class="container-md mt-2">
        <div class="grid" id="posts">
            <div class="d-flex justify-content-center">
                <div class="spinner-border">
                    <span class="visually-hidden">Loading Posts...</span>
                </div>
            </div>
        </div>
</main>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    const listOfConnections = JSON.parse('{{connections|escapejs}}');

    function deletePost(id) {
        // DELETE a post
        url = new URL(id)
        fetch_url = "/api" + url.pathname + "/"
        fetch(fetch_url, { headers: new Headers({ "X-CSRFToken": "{{ csrf_token }}", "Authorization": "Token 516e5c3d636f46228edb8f09b9613d5b4b166816" }), method: 'DELETE' })
            .then((response) => response.status())
            .then(window.location.reload())
    }
    //https://www.w3docs.com/snippets/html/how-to-create-an-html-button-that-acts-like-a-link.html
    function editPost(id) {
        url = new URL(id)
        window.location.href = url.pathname + "/edit/"
    }
    // GET and display comments for a post
    let commentsList = [];
    let commentIndex = 0;
    async function getComment(author_id, post_id, host_name, type) {
        if (type == 'internal') {
            const url = `/api/authors/${author_id}/posts/${post_id}/comments/`
            const response = await fetch(url, {
                method: "GET",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Authorization": "Token 516e5c3d636f46228edb8f09b9613d5b4b166816"
                },
            }).then(response => response.json())
                .then(data => {
                    commentsList = commentsList.concat(data.items);
                    for (const comment of data.items) {
                        comment_html =
                            `<h6 class="card-text" > 
                                <b class="ml-5"><a href=${comment.author.url}>${comment.author.displayName}</a></b> ${comment.comment} 
                                <button id="like-comment-${commentIndex}" type="button" class="btn btn-light btn-sm ml-20" onclick="likeComment(${commentIndex})">
                                    <i class="fa-regular fa-heart"></i>
                                </button>
                            </h6>`
                        document.getElementById(`comment-${post_id}`).innerHTML += comment_html
                        isCommentLiked(commentIndex);
                        commentIndex += 1;
                    }
                });
        } else if (type === 'external') {
            const hostname = "https://" + host_name;
            let parent_post_url = `${hostname}/authors/${author_id}/posts/${post_id}`
            let author_url = `${hostname}/authors/${author_id}`
            let url = `${hostname}/api/authors/${author_id}/posts/${post_id}/comments/`
            if (hostname == "https://social-distribution-w23-t17.herokuapp.com") {
                url = `${hostname}/authors/${author_url}/posts/${parent_post_url}/comments/?page=1&size=1000`
            }
            else if (hostname == "https://social-distribution-media.herokuapp.com") {
                url = `${hostname}/api/authors/${author_id}/posts/${post_id}/comments?page=1&size=1000`
            }
            const remoteConnection = listOfConnections.find(connection => connection.hostName === hostname);
            let authorization = remoteConnection.apiCreds;
            const response = await fetch(url, {
                method: "GET",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Authorization": authorization
                },
            }).then(response => response.json())
                .then(data => {
                    commentsList = commentsList.concat(data.items);
                    for (const comment of data.items) {
                        comment_html =
                            `<h6 class="card-text" > 
                            <b class="ml-5"><a href=${comment.author.url}>${comment.author.displayName}</a></b> ${comment.comment} 
                            <button id="like-comment-${commentIndex}" type="button" class="btn btn-light btn-sm ml-20" onclick="likeComment(${commentIndex})">
                                <i class="fa-regular fa-heart"></i>
                            </button>
                        </h6>`
                        document.getElementById(`comment-${post_id}`).innerHTML += comment_html
                        isCommentLiked(commentIndex);
                        commentIndex += 1;
                    }
                });
        }

    }

    async function likeComment(i) {
        // POST a like object to the author's inbox
        const comment = commentsList[i];
        const authorID = comment.author.id.split("/").pop();
        const hostname = comment.author.host;
        let authorization = "Token 516e5c3d636f46228edb8f09b9613d5b4b166816";
        let url = `${hostname}/api/authors/${authorID}/inbox/`;
        if (hostname == "https://socialdistcmput404.herokuapp.com/") { // not a remote author
            url = `/api/authors/${authorID}/inbox/`
        } else {
            const remoteConnection = listOfConnections.find(connection => connection.hostName === hostname);
            authorization = remoteConnection.apiCreds;
            if (hostname == "https://social-distribution-w23-t17.herokuapp.com") {
                url = `${hostname}/authors/${comment.author.id}/inbox/`
            }
        }
        const data = {
            "@context": "Comment Like",
            "summary": current_author.displayName + " likes a comment on your post",
            "type": "Like",
            "author": current_author,
            "object": comment.id
        }
        // POST a like object to the author's inbox
        const response = await fetch(url, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}",
                "Authorization": authorization
            },
            body: JSON.stringify(data),
        });
        if (response.status == 200) {
            document.getElementById(`like-comment-${i}`).innerHTML = `<i class="fa-solid fa-heart"></i>`;
            document.getElementById(`like-comment-${i}`).disabled = true;
        } else {
            console.log(response.status, response.statusText)
        }
    }
    function postComment(post_id, foreignauthor_id, type) {
        if (type === 'internal') {
            console.log(post_id)
            url = new URL(post_id)
            window.location.href = url.pathname + "/comments/"
        } else if (type === 'external') {
            console.log(post_id, foreignauthor_id, type)
            url = new URL(post_id)
            post_id = post_id.split("/").pop()
            window.location.href = `https://socialdistcmput404.herokuapp.com/posts/foreign/${url.hostname}/authors/${foreignauthor_id}/posts/${post_id}/comments`
        }
    }
    async function isCommentLiked(i) {
        // checks if current user liked the comment
        // i is index of comment in commentsList
        const comment = commentsList[i];
        const authorID = comment.author.id.split("/").pop();
        let authorization = "Token 516e5c3d636f46228edb8f09b9613d5b4b166816";
        const url = `/api/${new URL(comment.id).pathname}/likes`
        // GET list of likes for the post
        const response = await fetch(url, {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}",
                "Authorization": authorization,
            },
        }).then(response => response.json())
            .then(data => {
                for (like of data.items) {
                    console.log(like.author.id, current_author.id)
                    if (like.author.id == current_author.id) {
                        document.getElementById(`like-comment-${i}`).innerHTML = `<i class="fa-solid fa-heart"></i>`;
                        document.getElementById(`like-comment-${i}`).disabled = true;
                    }
                }
            });

    }
    var current_author = JSON.parse('{{current_author|escapejs}}');
    var posts = [];
    var externalPosts = [];
    // GET all public posts and display them
    fetch("/api/posts/", { headers: new Headers({ "Authorization": "Token 516e5c3d636f46228edb8f09b9613d5b4b166816" }) })
        .then((response) => response.json())
        .then((data) => {
            if (data.items.length === 0) {
                document.getElementById('posts').innerHTML = `<div class="d-flex justify-content-center py-4"><h3>No posts to show.</h3></div>`
                return
            }
            posts = data.items;
            document.getElementById('posts').innerHTML = posts.map((post, index) => {
                let content;
                if (post.contentType.startsWith("image")) {
                    content = `<img class="img-fluid mx-auto d-block" style="max-width: 50%" src="data:${post.contentType}, ${post.content}"/><br>`;
                }
                else {
                    if (post.contentType === "text/markdown") {
                        post.title = marked.parse(post.title);
                        post.description = marked.parse(post.description);
                        content = `<p class="card-text">${marked.parse(post.content)}</p>`;
                    } else {
                        content = `<p class="card-text">${post.content}</p>`;
                    }
                }
                post_url = new URL(post.id);
                author_url = new URL(post.author.url);
                post_relative_path = post_url.pathname + "/";
                author_relative_path = author_url.pathname + "/";
                author_arr = author_url.pathname.split("/");
                post_arr = post_url.pathname.split("/");
                post_id = post_arr[post_arr.length - 1];
                author_id = author_arr[author_arr.length - 1];

                // OLD CODE under card-body
                // <h5 class="card-title"><a href="${post_relative_path}">${post.title}</a></h5>
                // <h6 class="card-subtitle mb-2 text-muted"><a href="${author_relative_path}">${post.author.displayName}</a></h6>
                // <h6 class="card-subtitle mb-2 text-muted">${post.description}</h6>
                // <span class="badge bg-secondary">${post.categories}</span>
                // ${content}
                // <button type="button" class="btn btn-secondary btn-sm" id="like-btn-${index}-internal" onclick="likePost(${index}, 'internal')">
                //     <i class="fa-regular fa-heart"></i>
                // </button>`
                display_posts = `
                            <div class="card my-3" id="post-${post_id}">
                                <div class="card-body">
                                    <h4 class="card-title"><a class="link-secondary" href="${post_relative_path}">${post.title}</a></h4>
                                    <h5 class="card-subtitle my-3 text-muted">
                                        <img src="${post.author.profileImage || `https://ui-avatars.com/api/?name=${post.author.displayName}`}" class="rounded-circle" style="width: 30px; height: 30px; object-fit: cover;">
                                        <a class="link-secondary mx-1" href="${author_relative_path}">${post.author.displayName}</a>
                                    </h5>
                                    <h5 class="card-subtitle mt-2 mb-2 text-muted">${post.description}</h5>
                                    <span class="badge bg-secondary mb-2">${post.categories}</span>
                                    <p class="post-content mb-2">${content}</p>
                                    <button type="button" class="btn btn-secondary btn-sm" id="like-btn-${index}-internal" onclick="likePost(${index}, 'internal')">
                                        <i class="fa-regular fa-heart"></i>
                                    </button>
                                    <button type="button" class="btn btn-secondary btn-sm" onclick="postComment('${post.id}','${author_id}','internal')">
                                        <i class="fa-regular fa-comment"></i>
                                    </button>
                                    <button type="button" id="share-btn" class="btn btn-secondary btn-sm" onclick="sharePost(${index}, 'internal')">
                                    <i class="fa fa-share"></i>
                                    </button>`
                if (post.author.id == current_author.id) {
                    display_posts += `
                                    <button type="button" id="edit-btn" class="btn btn-secondary btn-sm" onclick="editPost('${post.id}')">
                                        <i class="fa-solid fa-pen"></i>
                                    </button>
                                    <button type="button" class="btn btn-danger btn-sm" onclick="deletePost('${post.id}')">
                                        <i class="fa-solid fa-trash"></i>
                                    </button>
                                    `
                }
                getComment(author_id, post_id, '', 'internal')
                likedby = `<h6 class="card-text my-3" id="liked-${post_id}"> Liked by <b>"random user"</b> and <b>"likes count"</b> others </h6> `
                comment = `<br><br><div id="comment-${post_id}"></div>`
                display_posts += likedby + comment
                isLiked(index, 'internal'); // check if post is liked by user
                return (display_posts + '</div></div>')
            }).join('');
        })
        .catch((error) => {
            console.error("Fetch error:", error);
            document.getElementById('posts').innerHTML = `<div class="d-flex justify-content-center py-4"><h3>Error fetching posts</h3></div>`
        });

    async function likePost(i, type) {
        // i is the index of the post in the posts/externalPosts array
        // type is either internal or external
        const source = type === "internal" ? posts : externalPosts;
        const post = source[i];
        const authorURL = post.author.id;
        const authorID = post.author.id.split("/").pop();
        const hostname = type === "external" ? "https://" + new URL(post.author.id).hostname : "";
        let url = `${hostname}/api/authors/${authorID}/inbox/`;
        if (hostname === "https://social-distribution-w23-t17.herokuapp.com") {
            url = `${hostname}/authors/${authorURL}/inbox/`;
        }
        if (hostname === "https://social-distribution-media.herokuapp.com") {
            url = `${hostname}/api/authors/${authorID}/inbox`;
        }
        let authorization = "Token 516e5c3d636f46228edb8f09b9613d5b4b166816";
        if (type === "external") {
            const remoteConnection = listOfConnections.find(connection => connection.hostName === hostname);
            authorization = remoteConnection.apiCreds;
        }
        let data = {
            "@context": "Post Like",
            "summary": "{{ user.username }} Likes your post",
            "type": "Like",
            "author": current_author,
            "object": post.id
        }
        if (hostname == "https://social-distribution-media.herokuapp.com") {
            data = {
                "@context": "Post Like",
                "summary": "{{ user.username }} Likes your post",
                "type": "like",
                "author": current_author,
                "object": {
                    "type": "like",
                    "summary": "{{ user.username }} Likes your post",
                    "author": current_author,
                    "object": post.id
                }
            };
        }
        // POST a like object to the author's inbox
        const response = await fetch(url, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}",
                "Authorization": authorization
            },
            body: JSON.stringify(data),
        });
        if (response.status == 200 || response.status == 201 || response.status == 202) {
            document.getElementById(`like-btn-${i}-${type}`).innerHTML = `<i class="fa-solid fa-heart"></i>`;
            document.getElementById(`like-btn-${i}-${type}`).disabled = true;
        } else {
            console.log(response.status, response.statusText)
        }
    }

    async function isLiked(i, type) {
        // checks if current user liked the post
        // i is the index of the post in the posts/externalPosts array
        // type is either internal or external
        const source = type === "internal" ? posts : externalPosts;
        const post = source[i];
        const authorURL = post.author.id;
        const authorID = post.author.id.split("/").pop();
        const postURL = post.id;
        const hostname = type === "external" ? "https://" + new URL(post.author.id).hostname : "";
        let url = `${hostname}/api/authors/${authorID}/posts/${post.id.split('/').pop()}/likes/`;
        if (hostname === "https://social-distribution-w23-t17.herokuapp.com") {
            url = `${hostname}/authors/${authorURL}/posts/${postURL}/likes/`;
        }
        if (hostname === "https://social-distribution-media.herokuapp.com") {
            url = `${hostname}/api/authors/${authorID}/posts/${post.id.split('/').pop()}/likes`
        }
        let authorization = "Token 516e5c3d636f46228edb8f09b9613d5b4b166816";
        if (type === "external") {
            const remoteConnection = listOfConnections.find(connection => connection.hostName === hostname);
            authorization = remoteConnection.apiCreds;
        }
        // GET list of likes for the post
        const response = await fetch(url, {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}",
                "Authorization": authorization,
            },
        }).then(response => response.json())
            .then(data => {
                for (like of data.items) {
                    if (like.author.url == current_author.id) {
                        document.getElementById(`like-btn-${i}-${type}`).innerHTML = `<i class="fa-solid fa-heart"></i>`;
                        document.getElementById(`like-btn-${i}-${type}`).disabled = true;
                    }
                }
            });
    }

    // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date/Date
    // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date/toISOString
    async function sharePost(i, type) {
        const source = type === "internal" ? posts : externalPosts;
        const post = source[i];
        let author_url = new URL(current_author.id)
        let author_relative_path = author_url.pathname
        let date = new Date();
        // refresh "published" date
        post["published"] = date.toISOString();
        fetch("/api" + author_relative_path + "/followers/", {
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}",
                "Authorization": "Token 516e5c3d636f46228edb8f09b9613d5b4b166816"
            }
        })
            .then((response) => response.json())
            .then((data) => {
                followers = data.items;
                for (follower of followers) {
                    sendToInbox(follower.id, post);
                }
            })
    }

    async function sendToInbox(id, data) {
        // Send post to a user's inbox
        let url = new URL(id);
        let author_relative_path = url.pathname + "/"
        for (connection of listOfConnections) {
            if ("https://" + url.hostname == connection.hostName) {
                author_relative_path = author_relative_path.replace("/api", "");
                author_relative_path = author_relative_path.replace("/main", "");
                let inbox_url = connection.apiAddress + author_relative_path + "inbox/";
                if (connection.hostName == "https://social-distribution-w23-t17.herokuapp.com") {
                    inbox_url = connection.apiAddress + "/authors/" + id + "/inbox/"
                }
                if (connection.hostName == "https://social-distribution-media.herokuapp.com") {
                    data["categories"] = data["categories"].split()
                    data = {
                        "@context": "sending to inbox",
                        "summary": data.author.displayName + " created a post!",
                        "type": "post",
                        "author": data.author,
                        "object": data
                    }
                    inbox_url = connection.apiAddress + author_relative_path + "inbox";
                }
                fetch(inbox_url, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": "{{ csrf_token }}",
                        "Authorization": connection.apiCreds
                    },
                    body: JSON.stringify(data),
                });
                break;
            }
            else if ("https://" + url.hostname == "https://socialdistcmput404.herokuapp.com") {
                fetch("/api" + author_relative_path + "inbox/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": "{{ csrf_token }}",
                        "Authorization": "Token 516e5c3d636f46228edb8f09b9613d5b4b166816"
                    },
                    body: JSON.stringify(data),
                });
                break;
            }
        }
    }

    fetchExternalPosts();
    //Source: https://stackoverflow.com/questions/494143/creating-a-new-dom-element-from-an-html-string-using-built-in-dom-methods-or-pro/35385518#35385518
    function htmlToElement(html) {
        var template = document.createElement('template');
        template.innerHTML = html;
        return template.content;
    }

    async function fetchExternalPosts() {
        var listOfConnections = JSON.parse('{{connections|escapejs}}');
        let i = 0;
        // fetch foreign posts and render
        //Source: https://stackoverflow.com/questions/43305020/how-to-use-the-context-variables-passed-from-django-in-javascript
        for (connection of listOfConnections) {
            try {
                let returnedData;
                let queryString = "";
                let authorsPath = "/authors/"
                if (connection.hostName == "https://social-distribution-w23-t17.herokuapp.com") {
                    queryString = "?page=1&size=1000";
                }
                if (connection.hostName == "https://social-distribution-media.herokuapp.com") {
                    authorsPath = "/authors";
                    queryString = "?page=1&size=1000";
                }
                if (connection.apiCreds === "") {
                    returnedData = await fetch(connection.apiAddress + authorsPath + queryString,
                        { headers: new Headers({ "Accept": "application/json" }) });
                }
                else {
                    returnedData = await fetch(connection.apiAddress + authorsPath + queryString,
                        {
                            headers: new Headers({
                                "Authorization": connection.apiCreds,
                                "Accept": "application/json"
                            })
                        });
                }
                let returnedDatatext = await returnedData.text();
                let returnedDataList = JSON.parse(returnedDatatext);
                if (returnedDataList.items.length == 0) {
                    continue
                }
                for (data of returnedDataList.items) {
                    // https://dmitripavlutin.com/parse-url-javascript/
                    try {
                        let data_url = new URL(data.id);
                        let data_path = data_url.pathname;
                        let index = data_path.search("/api");
                        let posts_path = "/posts/"
                        if (index != -1) {
                            data_path = data_path.substring(index + 4)
                        }
                        let posts_response;
                        if (connection.hostName == "https://social-distribution-media.herokuapp.com") {
                            posts_path = "/posts"
                        }
                        if (connection.hostName == "https://social-distribution-w23-t17.herokuapp.com") {
                            posts_response = await fetch(connection.apiAddress + "/authors/" + data.id + posts_path,
                                {
                                    headers: new Headers({
                                        "Authorization": connection.apiCreds,
                                        "Accept": "application/json",
                                    })
                                });
                        }
                        else {
                            posts_response = await fetch(connection.apiAddress + data_path + posts_path,
                                {
                                    headers: new Headers({
                                        "Authorization": connection.apiCreds,
                                        "Accept": "application/json",
                                    })
                                });
                        }

                        let posts_list_json = await posts_response.text();
                        let post_list_obj = JSON.parse(posts_list_json);
                        let posts;
                        if (post_list_obj.items == undefined) {
                            posts = post_list_obj;
                        }
                        else {
                            posts = post_list_obj.items;
                        }
                        if (posts.length == 0) {
                            continue;
                        }
                        externalPosts = externalPosts.concat(posts);
                        for (post of posts) {
                            try {
                                let content;
                                // ensure we dont render unlisted posts of our connected nodes
                                if (post.unlisted) {
                                    continue
                                }
                                if (post.contentType.startsWith("image")) {
                                    content = `<img class="img-fluid mx-auto d-block" style="max-width: 50%" src="data:${post.contentType}, ${post.content}"/><br>`;
                                } else if (post.contentType === "text/markdown") {
                                    post.title = marked.parse(post.title);
                                    post.description = marked.parse(post.description);
                                    content = `<p class="card-text">${marked.parse(post.content)}</p>`;
                                } else {
                                    content = `<p class="card-text">${post.content}</p>`;
                                }
                                const post_id = post.id.split("/").pop()
                                const author_id = post.author.id.split("/").pop()
                                const post_url = new URL(post.id)
                                const host_name = post_url.hostname
                                getComment(author_id, post_id, host_name, 'external')
                                // OLD htmlElement:
                                // <div class="card my-3">
                                //     <div class="card-body">
                                //         <h5 class="card-title"><a href="${post.id}">${post.title}</a></h5>
                                //         <h6 class="card-subtitle mb-2 text-muted"><a href="${post.author.url}">${post.author.displayName}</a></h6>
                                //         <h6 class="card-subtitle mb-2 text-muted">${post.description}</h6>
                                //         <span class="badge bg-secondary">${post.categories}</span>
                                //         ${content}
                                //         <button type="button" class="btn btn-secondary btn-sm" id="like-btn-${i}-external" onclick="likePost(${i}, 'external')">
                                //             <i class="fa-regular fa-heart"></i>
                                //         </button>
                                //     </div>
                                // </div>

                                var htmlElement = htmlToElement(`
                                            <div class="card my-3">
                                                <div class="card-body">
                                                    <h4 class="card-title"><a href="${post.id}">${post.title}</a></h4>
                                                    <br>
                                                    <h5 class="card-subtitle mb-2 text-muted">Author: <a href="${post.author.url}">${post.author.displayName}</a></h5>
                                                    <h5 class="card-subtitle mb-2 text-muted">${post.description}</h5>
                                                    <span class="badge bg-secondary">${post.categories}</span>
                                                    <br><br><br>
                                                    <h6 class="post-content">${content}</h6>
                                                    <br>
                                                    <button type="button" class="btn btn-secondary btn-sm" id="like-btn-${i}-external" onclick="likePost(${i}, 'external')">
                                                        <i class="fa-regular fa-heart"></i> 
                                                    </button>
                                                    <button type="button" class="btn btn-secondary btn-sm" onclick="postComment('${post.id}','${author_id}','external')">
                                                        Comment
                                                    </button>
                                                    <button type="button" id="share-btn" class="btn btn-secondary btn-sm" onclick="sharePost(${i}, 'external')">
                                                        <i class="fa fa-share"></i>
                                                    </button>
                                                    <h6 class="card-text my-3" id="liked-${post_id}"> Liked by <b>"random user"</b> and <b>"likes count"</b> others </h6> 
                                                    <br><br>
                                                    <div id="comment-${post_id}"></div>
                                                </div>
                                            </div>
                                        `);
                                document.getElementById("posts").appendChild(htmlElement);
                                isLiked(i, 'external');
                                i++;
                            }
                            catch {
                                continue;
                            }
                        }
                    }
                    catch {
                        continue;
                    }
                }
            }
            catch {
                continue;
            }
        }
    }
</script>

{% endblock content %}