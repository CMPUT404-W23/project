<!-- https://getbootstrap.com/docs/5.3/components/dropdowns/ -->
{% extends 'base.html' %}
{% block content %}
<div class="grid" id="post">
    <div class="d-flex justify-content-center">
        <div class="spinner-border">
          <span class="visually-hidden">Loading Post...</span>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    let data_url = new URL("{{post.id}}");
    let data_path = data_url.pathname;
    let post;
    function deletePost(id){
                url = new URL(id)
                fetch_url = "/api" + url.pathname +"/"
                fetch(fetch_url, {headers: new Headers({"X-CSRFToken": "{{ csrf_token }}","Authorization": "Token 516e5c3d636f46228edb8f09b9613d5b4b166816"}), method: 'DELETE'})
                .then((response) => response.status())
                .then(window.location.reload())
    }
    //https://www.w3docs.com/snippets/html/how-to-create-an-html-button-that-acts-like-a-link.html
    function editPost(id) {
        url = new URL(id)
        window.location.href= url.pathname + "/edit/"
    }
    function postComment(id){
        url = new URL(id)
        window.location.href = url.pathname + "/comments/"
    }
    fetch("/api" + data_path + "/",  
          {headers: new Headers({"Authorization": "Token 516e5c3d636f46228edb8f09b9613d5b4b166816"})})
    .then((response) => response.json())
    .then((data) => {
        post = data;
        post_url = new URL(post.id)
        author_url = new URL(post.author.url)
        post_relative_path = post_url.pathname + "/"
        author_relative_path = author_url.pathname + "/"
        author_arr = author_url.pathname.split("/");
        post_arr = post_url.pathname.split("/");
        post_id = post_arr[post_arr.length-1];
        author_id = author_arr[author_arr.length-1];
        let content;
        if (post.contentType.startsWith("image")) {
            content = `<img class="img-fluid mx-auto d-block" style="max-width: 50%" src="data:${post.contentType}, ${post.content}"/><br>`;
        } else if (post.contentType === "text/markdown") {
            post.title = marked.parse(post.title);
            post.description = marked.parse(post.description);
            content = `<p class="card-text">${marked.parse(post.content)}</p>`;
        } else {
            content = `<p class="card-text">${post.content}</p>`;
        }
        display_post = `
                        <div class="card my-3" id="post-${post_id}">
                            <div class="card-body">
                                <h5 class="card-title"><a href="${post_relative_path}">${post.title}</a></h5>
                                <h6 class="card-subtitle mb-2 text-muted"><a href="${author_relative_path}">${post.author.displayName}</a></h6>
                                <h6 class="card-subtitle mb-2 text-muted">${post.description} <span class="badge bg-secondary">${post.categories}</span></h6>
                                ${content}
                                <button type="button" class="btn btn-secondary btn-sm">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-heart" viewBox="0 0 16 16">
                                        <path d="m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523 1.023-.641 2.5.314 4.385.92 1.815 2.834 3.989 6.286 6.357 3.452-2.368 5.365-4.542 6.286-6.357.955-1.886.838-3.362.314-4.385C13.486.878 10.4.28 8.717 2.01L8 2.748zM8 15C-7.333 4.868 3.279-3.04 7.824 1.143c.06.055.119.112.176.171a3.12 3.12 0 0 1 .176-.17C12.72-3.042 23.333 4.867 8 15z"/>
                                    </svg>   
                                </button>` 
        if (author_id == "{{user.id}}") {
            display_post += `
                    <button onclick="deletePost('${post.id}')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash-fill" viewBox="0 0 16 16">
                            <path d="M2.5 1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1H3v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V4h.5a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H10a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1H2.5zm3 4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5zM8 5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7A.5.5 0 0 1 8 5zm3 .5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 1 0z"/>
                        </svg>
                    </button>
                    <button onclick="editPost('${post.id}')">
                        Edit
                    </button>
                    <button type="button" class="btn btn-secondary btn-sm" onclick="postComment('${post.id}')">
                                    Comment
                    </button>
                    `
        }      
        document.getElementById("post").innerHTML = display_post + '</div></div>'
        });
</script>
{% endblock content %}