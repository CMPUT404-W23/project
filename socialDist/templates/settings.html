{% extends 'base.html' %} {% block content %}
<div class="container my-4">
  <div id="save-alert"></div>
  <form>
    <!-- <h2 class="border-bottom py-3">Settings: </h2> -->
      
    <!-- heading -->
    <div class="container-md mt-3">
      <!-- Show image and name-->
      <h1 class="fw-bold">
        <!-- Show profile image if author has, otherwise show default image -->
        {% if author.profileImage %}
        <img src="{{author.profileImage}}" class="rounded-circle" style="width: 100px; height: 100px; object-fit: cover;">
        {% else %}
        <img src="https://ui-avatars.com/api/?name={{author.displayName}}&size=100" class="rounded-circle"
          style="width: 100px; height: 100px; object-fit: cover;">
        {% endif %}
        Settings for {{author.displayName}}
      </h1>

      {% load tz %}
      <i>Last login: {{ user.last_login|timezone:"America/Edmonton" }} MST</i>
      <br><br><br>
      <!-- Print rest of author's fields -->

      <!-- {% if author.github %}
      <p>GitHub: {{author.github}}</p>
      {% endif %} -->
    </div>

      <!-- set a temp class name -->
    <div class="author-settings">
      <h3 class="fw-bold text-decloration:"><u>Your Account Information:</u></h3><br>

      <h4 class="fw-bold">ID:</h4>
      <h5>{{author.id}}</h5><br>

      <h4 class="fw-bold">Host: </h4>
      <h5>{{author.host}}</h5><br>

      <h4 class="fw-bold">Name: </h4>
      <h5>{{author.displayName}}</h5><br>

      <h4 class="fw-bold">GitHub URL: </h4>
      <h5>{{author.github}}</h5><br>

      <h4 class="fw-bold">Profile Image URL: </h4>
      <h5>{{author.profileImage}}</h5>
    </div>
    <br>
    <hr>

    <!-- Edit profile fields -->
    <h4 class="fw-bold"><u>Edit Your Account</u></h4>
    <i>*Only edited fields will Be changed, feel free to leave fields blank/unedited if you don't want them to be changed</i>
    <div class="my-3">
      <label for="username" class="form-label">Username</label>
      <!-- OLD code -->
      <!-- <input type="text" class="form-control" id="username" value="{{author.displayName}}" required> -->
      <input type="text" class="form-control" id="username" value="{{author.displayName}}" placeholder="Maximum 40 characters">
    </div>
    <div class="mb-3">
      <label for="github" class="form-label">GitHub</label>
      <!-- OLD code -->
      <!-- <input type="url" class="form-control" id="github" value="{{author.github}}" required> -->
      <input type="url" class="form-control" id="github" value="{{author.github}}" placeholder="ex. https://github.com/sampleUserAccount">
    </div>
    <div class="mb-3">
      <label for="pfp-link" class="form-label">Profile Image Link</label>
      <!-- OLD Code -->
      <!-- <input type="url" class="form-control" id="pfp-link" value="{{author.profileImage}}" required> -->
      <input type="url" class="form-control" id="pfp-link" value="{{author.profileImage}}" placeholder="ex. https://i.imgur.com/sampleUserImage.jpeg">
    </div>

    <!-- Commented password in case we need it again -->
    <!-- <h3 class="mt-5">Change Password (Coming soon)</h3>
    <div class="mb-3">
      <label for="current-password" class="form-label">Current Password</label>
      <input
        type="password"
        class="form-control"
        id="current-password"
        placeholder="Enter your current password"
        disabled
      />
    </div>
    <div class="mb-3">
      <label for="new-password" class="form-label">New Password</label>
      <input
        type="password"
        class="form-control"
        id="new-password"
        placeholder="Enter new password"
        disabled
      />
    </div>
    <div class="mb-3">
      <label for="confirm-password" class="form-label">Confirm Password</label>
      <input
        type="password"
        class="form-control"
        id="confirm-password"
        placeholder="Re-enter new password"
        disabled
      />
    </div> -->
    <button
      type="submit"
      class="btn btn-primary"
      id="settings_save_changes"
      onclick="sendUserInfo(event)"
    >
      Save Changes
    </button>
  </form>

  <!-- ALEX'S CODE START-->
  <hr><br><br>
  <!-- posting Github stream-->
  <h3 class="fw-bold text-center"><u>Your GitHub Activity Stream:</u></h3>
  <div id="stream">
    <script>
      // Should be 

      // fetch('https://api.github.com/users/Alex-Mak-MCW/events')
      fetch("{{author.github}}")
        .then(res => {
          return res.json();
        })
        .then(data => {
          console.log(data);
          // data.forEach(user => {
          var mainContainer = document.getElementById("stream");
          for (var i = 0; i < data.length; i++) {
            var innerDiv = document.createElement("div");
            // console.log(data[0]);
            var output = "";
            for (var property in data[i]) {
              output += property + ': ' + JSON.stringify(data[i][property], null, 4) + ';<br><br>';
            }
            innerDiv.innerHTML = output + "<hr>";
            // innerDiv.innerHTML = JSON.stringify(data[i], null, 4)+"<br><br>";
            mainContainer.appendChild(innerDiv);
          }
        })
        .catch(error => {
          // comment it out incase we need it
          //  var failContainer = document.getElementById("stream");
          //  var failInnerDiv = document.createElement("div");
          //  innerDiv.innerHTML = "<h3>Please Provide a Valid URL to see Your GitHub Activity Stream</h3>"
          //  failContainer.appendChild(failInnerDiv);
          console.log(error);
        }
        );
    </script>
  </div>
  <br><br>
  <h5 class="fw-bold text-center"><i>Please Provide a Valid URL to See Your GitHub Activity Stream if Your Stream is Empty</i></h5>
</div>

<!-- ALEX'S CODE ENDS-->

{% csrf_token %}
<script>
  function displayAlert(alertType, alertMessage) {
    alertContainer = document.getElementById("save-alert");
    alertContainer.innerHTML = "";
    saveAlert = document.createElement("div");
    saveAlert.classList.add("alert", alertType);
    saveAlert.innerText = alertMessage;
    alertContainer.appendChild(saveAlert);
  }

  function sendUserInfo(e) {
    alertContainer = document.getElementById("save-alert");
    e.preventDefault();
    const httpRequest = new XMLHttpRequest();
    httpRequest.onreadystatechange = () => {
      if (httpRequest.readyState === XMLHttpRequest.DONE) {
        if (httpRequest.status === 201) {
          displayAlert("alert-success", "Changes saved successfully!");
        } else {
          displayAlert(
            "alert-danger",
            `An error occurred while saving: ${httpRequest.statusText}`
          );
        }
      }
    };

    const data = {
      displayName: document.getElementById("username").value,
      github: document.getElementById("github").value,
      profileImage: document.getElementById("pfp-link").value,
    };

    // if no fields changed at all
    if (
      "{{author.displayName}}" === data.displayName &&
      "{{author.github}}" === data.github &&
      "{{author.profileImage}}" === data.profileImage
    ) {
      displayAlert("alert-warning", "No changes detected.");
      return;
    }

    // FIX 
    // IF changes are NOTmade in displayName, sub the original value back in
    if (data.displayName === ""){
      data.displayName="{{author.displayName}}";
    }
    if (data.github === "") {
      data.github = "{{author.github}}";
    }
    if (data.profileImage === "") {
      data.profileImage = "{{author.profileImage}}";
    }

    
    // Comment it out for now
    // if any fields are empty
    /*
    if (
      data.displayName === "" ||
      data.github === "" ||
      data.profileImage === ""
    ) {
      displayAlert("alert-danger", "Please fill out all fields.");
      return;
    }
    */

    let author_url = new URL("{{author.id}}")
    let author_relative_path = author_url.pathname
    httpRequest.open(
      "POST",
      "/api" + author_relative_path + "/"
    );
    httpRequest.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
    httpRequest.setRequestHeader("Content-Type", "application/json");
    httpRequest.setRequestHeader("Authorization", "Token 516e5c3d636f46228edb8f09b9613d5b4b166816");
    httpRequest.send(JSON.stringify(data));
  }
</script>
{% endblock content %}
